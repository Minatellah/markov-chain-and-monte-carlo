---
title: "markov chain"
output: html_document
date: "2026-02-06"
---

```{r}
library(ggplot2)
library(markovchain)
```




```{r}
early <- new("markovchain",
             states = c("light", "heavy", "blocked"),
             transitionMatrix = matrix(c(0.4, 0.4, 0.2,  # From Light
                                       0.3, 0.5, 0.2,  # From Heavy
                                       0.0, 0.1, 0.9), # From blocked
                                       nrow = 3, byrow = TRUE))

rush_hour <- new("markovchain",
                 states = c("light", "heavy", "blocked"),
                 transitionMatrix = matrix(c(0.1, 0.5, 0.4, 
                                             0.1, 0.3, 0.6,
                                             0.0, 0.1, 0.9),
                                             nrow = 3, byrow = TRUE))

late <- new("markovchain",
            states = c("light", "heavy", "blocked"),
            transitionMatrix = matrix(c(0.6, 0.3, 0.1,
                                        0.4, 0.4, 0.2,
                                        0.2, 0.4, 0.4),
                                        nrow = 3, byrow = TRUE))


```



```{r}

intial_state <- c(0.7, 0.2, 0.1)
names(intial_state) <- c("light", "heavy", "blocked")


```

simulate the trafic

```{r}

time_step <- 72
state_probabilities <- matrix(0, nrow = time_step, ncol = 3) #create the table to fill with the proba later
state_probabilities[1, ] <- intial_state #intial state
colnames(state_probabilities) <- c("light", "heavy", "blocked")

```






```{r}

for (t in 2:time_step) {
  if(t<= 48) {
    state_probabilities[t, ] <- intial_state %*% early@transitionMatrix
  }
  else if(t<=60) {
    state_probabilities[t, ] <- intial_state %*% rush_hour@transitionMatrix
  }
  else {
    state_probabilities[t, ] <- intial_state %*% late@transitionMatrix
  }
  intial_state <- state_probabilities[t, ]  #intialize the state vector
  
  
}

state_probabilities


```

prepare the data




```{r}
trafic_data <- data.frame(
  Time = rep(seq(from =8, to =20, length.out = time_step), each=3), #light, heavy, blocked
  state = factor(rep(c("light", "heavy", "blocked"), times = time_step)),
  probabilities = as.vector(t(state_probabilities)) #transposÃ© de la matrice, parceque df fait par colonne
)

trafic_data
```

```{r}

trafic_plot <- ggplot(trafic_data, aes(x= Time, y=probabilities, colour = state)) +
  geom_line(size= 1) +
  labs(title = "Trafic states probabilities from 8am to 8pm", x="Time (hours)", y="probability") +
  theme_minimal() +
  theme(legend.position = "top", 
        plot.title = element_text(hjust = 0.5)) 

trafic_plot
```


```{r}
steady_state_early <- steadyStates(early)
steady_state_rush <- steadyStates(rush_hour)
steady_state_late <- steadyStates(late)

stady_mat <- rbind(
  early = (steady_state_early),
  rush_hour = (steady_state_rush),
  late = (steady_state_late)
)

stady_mat



```




```{r}


steady_colors <- c("black")
traffic_plot <- trafic_plot +
  
  
  annotate("segment", x = 8, xend = 16, y = steady_state_early[1], yend = steady_state_early[1],
           color = steady_colors, linetype = "dashed", linewidth = 0.8) + 
  annotate("segment", x = 8, xend = 16, y = steady_state_early[2], yend = steady_state_early[2],
           color = steady_colors, linetype = "dotted", linewidth = 0.8) + 
  annotate("segment", x = 8, xend = 16, y = steady_state_early[3], yend = steady_state_early[3],
           color = steady_colors, linetype = "dotdash", linewidth = 0.8) + 
  
  
  
  
  annotate("segment", x = 16, xend = 18, y = steady_state_rush[1], yend = steady_state_rush[1],
           color = steady_colors, linetype = "dashed", linewidth = 0.8) + 
  annotate("segment", x = 16, xend = 18, y = steady_state_rush[2], yend = steady_state_rush[2],
           color = steady_colors, linetype = "dotted", linewidth = 0.8) +
  annotate("segment", x = 16, xend = 18, y = steady_state_rush[3], yend = steady_state_rush[3],
           color = steady_colors, linetype = "dotdash", linewidth = 0.8) + 
  
  
  
  annotate("segment", x = 18, xend = 20, y = steady_state_late[1], yend = steady_state_late[1],
           color = steady_colors, linetype = "dashed", linewidth = 0.8) + 
  annotate("segment", x = 18, xend = 20, y = steady_state_late[2], yend = steady_state_late[2],
           color = steady_colors, linetype = "dotted", linewidth = 0.8) + 
  annotate("segment", x = 18, xend = 20, y = steady_state_late[3], yend = steady_state_late[3],
           color = steady_colors, linetype = "dotdash", linewidth = 0.8)




traffic_plot <- traffic_plot +
  annotate("text", x = 12, y = steady_state_early[1] + 0.05, label = "Steady State Early - Light", color = steady_colors, size = 3) +
  annotate("text", x = 12, y = steady_state_early[2] + 0.05, label = "Steady State Early - Heavy", color = steady_colors, size = 3) +
  annotate("text", x = 12, y = steady_state_early[3] - 0.05, label = "Steady State Early - ", color = steady_colors, size = 3) +
  
  annotate("text", x = 17, y = steady_state_rush[1] + 0.05, label = "Steady State Rush - Light", color = steady_colors, size = 3) +
  annotate("text", x = 17, y = steady_state_rush[2] + 0.05, label = "Steady State Rush - Heavy", color = steady_colors, size = 3) +
  annotate("text", x = 17, y = steady_state_rush[3] - 0.05, label = "Steady State Rush - Blocked", color = steady_colors, size = 3) +
  
  annotate("text", x = 19, y = steady_state_late[1] + 0.05, label = "Steady State Late - Light", color = steady_colors, size = 3) +
  annotate("text", x = 19, y = steady_state_late[2] + 0.05, label = "Steady State Late - Heavy", color = steady_colors, size = 3) +
  annotate("text", x = 19, y = steady_state_late[3] - 0.05, label = "Steady State Late - Blocked", color = steady_colors, size = 3)

traffic_plot
  

```



```{r}

timess <- 72
n <- 1000
start_state <- "light"
states <- c("light", "heavy", "blocked")

```


```{r}
simulate_mc <- function(mc, timess, n, start_state) {
  prob_matrix <- matrix(0, nrow = T, ncol = length(states))
  colnames(prob_matrix) <- states
  
  for (i in 1:n) {
    traj <- rmarkovchain(n = timess, object = mc, t0 = start_state)
    for (t in 1:timess) {
      prob_matrix[t, traj[t]] <- prob_matrix[t, traj[t]] + 1
    }
  }
  
  prob_matrix <- prob_matrix / N
  return(prob_matrix)
}
```


```{r}
prob_early <- simulate_mc(early, timess, n, start_state)
prob_rush <- simulate_mc(rush_hour, timess, n, start_state)
prob_late  <- simulate_mc(late, timess, n, start_state)
```

```{r}
steady_early <- steadyStates(early)
steady_rush  <- steadyStates(rush_hour)
steady_late  <- steadyStates(late)
```

```{r}
colors <- c("green", "orange", "red")
matplot(1:timess, prob_early, type="l", lty=1, lwd=2, col=colors,
        xlab="Time steps", ylab="Probability", ylim=c(0,1),
        main="Monte Carlo Simulation - Traffic States")
matlines(1:timess, prob_rush, lty=2, lwd=2, col=colors)  # dashed for rush hour
matlines(1:timess, prob_late, lty=3, lwd=2, col=colors)  # dotted for late

# Add steady-state lines
abline(h=steady_early[1,], col=colors, lty=1)  # early steady
abline(h=steady_rush[1,], col=colors, lty=2)   # rush steady
abline(h=steady_late[1,], col=colors, lty=3)   # late steady

legend("right", legend=c(paste(states,"early"), paste(states,"rush"), paste(states,"late")),
       col=rep(colors,3), lty=rep(1:3, each=3), lwd=2)
```










